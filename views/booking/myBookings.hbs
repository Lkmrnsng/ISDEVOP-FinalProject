{{!-- views/booking/myBookings.hbs --}}

<h1>My Bookings</h1>

{{#if bookings.length}}
    <div class="bookings-list">
        {{#each bookings}}
            <div class="booking-item">
                <h2>Booking ID: {{this.bookingID}}</h2>
                {{#if this.ride}}
                    <p>Ride: {{this.ride.pickupPoint}} to {{this.ride.dropoffPoint}} , RideID: {{this.ride.rideID}}</p>
                    {{#if this.driver}}
                        <p>Driver: {{this.driver.name}}</p>
                        <img src="{{this.driver.profilePicture}}" alt="Driver's profile picture" class="driver-photo">
                    {{else}}
                        <p>Driver information not available</p>
                    {{/if}}
                    <p>Departure: {{formatTime1 this.ride.departureTime}}</p>
                    <p>Price: â‚±{{this.ride.price}}</p>
                {{else}}
                    <p>Ride details not available</p>
                {{/if}}
                <p>Booking Dates: {{formatDate this.bookingDate}}</p>
                <p>Response Status: {{this.responseStatus}}</p>
                <p>Ride Status: {{this.rideStatus}}</p>
                <p>Payment Status: {{this.paymentStatus}}</p>
                {{#if (isActive this.rideStatus this.responseStatus)}}
                    <button class="cancel-booking" data-booking-id="{{this.bookingID}}">Cancel Booking</button>
                {{/if}}
            </div>
        {{/each}}
    </div>
{{else}}
    <p>You have no bookings yet.</p>
{{/if}}

<script>
    function handleCancellation(bookingId) {
        fetch(`/booking/${bookingId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.warning) {
                    alert(data.warning);
                }
                alert(data.message);
                location.reload(); // Reload the page to reflect the changes
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }

    document.querySelectorAll('.cancel-booking').forEach(button => {
        button.addEventListener('click', function() {
            const bookingId = this.getAttribute('data-booking-id');
            if (confirm('Are you sure you want to cancel this booking?')) {
                handleCancellation(bookingId);
            }
        });
    });
</script>