<div style="margin-top: 100px;"></div>

<h1>My Bookings</h1>

<div class="bookings-container">
    <div class="today-bookings">
        <h2>Bookings Scheduled Today</h2>
        {{#if todayBookings.length}}
            <ul class="booking-list">
                {{#each todayBookings}}
                    <div class="booking-item">
                    <a href="/booking/bookingDetails/{{this.bookingID}}">
                        <h2>Booking ID: {{this.bookingID}}</h2>
                        {{#if this.ride}}
                            <p>Ride: {{this.ride.pickupPoint}} to {{this.ride.dropoffPoint}}</p>
                            {{#if this.driver}}
                                <p>Driver: {{this.driver.name}}</p>
                                <img src="{{this.driver.profilePicture}}" alt="Driver's profile picture" class="driver-photo">
                            {{else}}
                                <p>Driver information not available</p>
                            {{/if}}
                            <p>Departure: {{formatTime1 this.ride.departureTime}}</p>
                            <p>Price: ₱{{this.ride.price}}</p>
                        {{else}}
                            <p>Ride details not available</p>
                        {{/if}}
                        <p>Driver Response: {{this.responseStatus}}</p>
                        <p>Ride Status: {{#if (eq this.rideStatus 'ongoing')}}On the Way{{else}}{{this.rideStatus}}{{/if}}</p>
                        <p>Payment Status: {{this.paymentStatus}}</p>
                        </a>
                        {{#if (isActive this.rideStatus this.responseStatus)}}
                            <button class="cancel-booking" data-booking-id="{{this.bookingID}}">Cancel Booking</button>
                        {{/if}}
                        <button class="message-driver" data-driver-id="{{this.ride.driverID}}">Message Driver</button>
                    </div>
                {{/each}}
            </ul>
        {{else}}
            <p>No bookings scheduled for today.</p>
        {{/if}}
    </div>

    <div class="other-bookings">
        <h2>All Bookings</h2>
        {{#if otherActiveBookings.length}}
            <ul class="booking-list">
                {{#each otherActiveBookings}}
                    <div class="booking-item">
                    <a href="/booking/bookingDetails/{{this.bookingID}}">
                        <h2>Booking ID: {{this.bookingID}}</h2>
                        {{#if this.ride}}
                            <p>Ride: {{this.ride.pickupPoint}} to {{this.ride.dropoffPoint}}</p>
                            {{#if this.driver}}
                                <p>Driver: {{this.driver.name}}</p>
                                <img src="{{this.driver.profilePicture}}" alt="Driver's profile picture" class="driver-photo">
                            {{else}}
                                <p>Driver information not available</p>
                            {{/if}}
                            <p>Departure: {{formatTime1 this.ride.departureTime}}</p>
                            <p>Price: ₱{{this.ride.price}}</p>
                        {{else}}
                            <p>Ride details not available</p>
                        {{/if}}
                        <p>Booking Date: {{formatDate this.bookingDate}}</p>
                        <p>Driver Response: {{this.responseStatus}}</p>
                        <p>Ride Status: {{#if (eq this.rideStatus 'ongoing')}}On the Way{{else}}{{this.rideStatus}}{{/if}}</p>
                        <p>Payment Status: {{this.paymentStatus}}</p>
                        </a>
                        {{#if (isActive this.rideStatus this.responseStatus)}}
                            <button class="cancel-booking" data-booking-id="{{this.bookingID}}">Cancel Booking</button>
                        {{/if}}
                        <button class="message-driver" data-driver-id="{{this.ride.driverID}}">Message Driver</button>
                    </div>
                {{/each}}
            </ul>
        {{else}}
            <p>No other active bookings.</p>
        {{/if}}
    </div>
</div>

<script>
    function handleCancellation(bookingId) {
        fetch(`/booking/${bookingId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.warning) {
                    alert(data.warning);
                }
                alert(data.message);
                location.reload(); // Reload the page to reflect the changes
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }

    document.querySelectorAll('.cancel-booking').forEach(button => {
        button.addEventListener('click', function() {
            const bookingId = this.getAttribute('data-booking-id');
            if (confirm('Are you sure you want to cancel this booking?')) {
                handleCancellation(bookingId);
            }
        });
    });

    document.querySelectorAll('.message-driver').forEach(button => {
        button.addEventListener('click', function() {
            const driverId = this.getAttribute('data-driver-id');
            // logic to open a chat with the driver
            // This could be opening a chat modal or redirecting to a chat page
            // TO BE IMPLEMENTED IN THE FUTURE
            console.log('Open chat with driver:', driverId);
            // Example: window.location.href = `/chat/${driverId}`;
        });
    });
</script>